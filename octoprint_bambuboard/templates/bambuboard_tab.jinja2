<div id="tab_plugin_bambuboard">
    <!-- Printer Selector -->
    <div class="bb-printer-selector">
        <select data-bind="options: printers, optionsText: function(p) { return p.name() + ' (' + p.printerModel() + ')'; }, optionsValue: 'id', value: selectedPrinterId" class="bb-select"></select>
        <button class="btn btn-small" data-bind="click: refreshPrinter, enable: selectedPrinter() && selectedPrinter().connected()" title="Refresh"><i class="fas fa-sync-alt"></i></button>
    </div>

    <!-- ko with: selectedPrinter -->

    <!-- Status Bar -->
    <div class="bb-status-bar" data-bind="css: statusClass()">
        <span class="bb-status-dot" data-bind="css: statusClass()"></span>
        <span data-bind="text: statusSummary"></span>
        <span class="bb-status-meta">
            <span data-bind="text: printerModel"></span>
            <span data-bind="visible: firmwareVersion(), text: 'FW: ' + firmwareVersion()"></span>
            <span data-bind="visible: nozzleDiameter() !== 'UNKNOWN', text: nozzleDiameterDisplay() + 'mm ' + nozzleTypeDisplay()"></span>
            <span data-bind="visible: wifiSignal(), text: 'WiFi: ' + wifiSignal()"></span>
        </span>
    </div>

    <!-- Camera Feed -->
    <!-- ko if: hasCamera -->
    <div class="bb-card bb-camera-card" id="bb-camera-section">
        <h4>
            <i class="fas fa-video"></i> Camera
            <button class="btn btn-mini" data-bind="click: $parent.toggleCameraStream, css: { active: cameraActive() }">
                <i class="fas" data-bind="css: { 'fa-play': !cameraActive(), 'fa-stop': cameraActive() }"></i>
                <span data-bind="text: cameraActive() ? 'Stop' : 'Start'"></span>
            </button>
            <button class="btn btn-mini" data-bind="click: $parent.cameraSnapshot" title="Take snapshot">
                <i class="fas fa-camera"></i>
            </button>
        </h4>
        <!-- ko if: cameraActive -->
        <img class="bb-camera-stream" data-bind="attr: { src: cameraStreamUrl }" alt="Camera feed">
        <!-- /ko -->
        <!-- ko ifnot: cameraActive -->
        <div class="bb-camera-placeholder" data-bind="visible: cameraAvailable()">Click Start to view camera feed</div>
        <div class="bb-camera-placeholder" data-bind="visible: !cameraAvailable()">
            <i class="fas fa-exclamation-circle"></i> Install <code>opencv-python-headless</code> to enable camera
        </div>
        <!-- /ko -->
    </div>
    <!-- /ko -->

    <!-- Print Progress -->
    <div class="bb-card" data-bind="visible: isPrinting() || isPaused()">
        <h4>Print Progress</h4>
        <div class="bb-progress-section">
            <div class="bb-filename" data-bind="text: subtaskName() || current3mfFile() || 'Unknown file'"></div>
            <div class="bb-progress-bar-container">
                <div class="bb-progress-bar" data-bind="style: { width: printPercentage() + '%' }">
                    <span data-bind="text: printPercentage() + '%'"></span>
                </div>
            </div>
            <div class="bb-progress-details">
                <span>Layer: <strong data-bind="text: currentLayer() + ' / ' + totalLayers()"></strong></span>
                <span>Stage: <strong data-bind="text: currentStageName() || gcodeState()"></strong></span>
                <span>Elapsed: <strong data-bind="text: elapsedTimeFormatted"></strong></span>
                <span>Remaining: <strong data-bind="text: remainingTimeFormatted"></strong></span>
            </div>
        </div>

        <!-- Skip Objects Panel -->
        <div class="bb-skip-objects" data-bind="visible: isPrinting()">
            <h5>Skip Objects</h5>
            <div data-bind="visible: skippedObjects().length > 0" class="bb-skipped-list">
                Skipped: <span data-bind="text: skippedObjects().join(', ')"></span>
            </div>
            <div class="bb-gcode-input">
                <input type="text" placeholder="Object IDs to skip (comma-separated)" data-bind="value: skipObjectsInput">
                <button class="btn btn-small" data-bind="click: $parent.skipObjects">Skip</button>
            </div>
        </div>
    </div>

    <!-- Active Tool Selector (H2D dual extruder only) -->
    <!-- ko if: hasDualExtruder -->
    <div class="bb-card">
        <h4>Active Extruder</h4>
        <div class="bb-controls-row">
            <label class="btn" data-bind="css: { active: activeTool() === 'RIGHT_EXTRUDER' }, click: function() { $parent.setActiveTool(0); }">
                <i class="fas fa-arrow-right"></i> Right (T0)
            </label>
            <label class="btn" data-bind="css: { active: activeTool() === 'LEFT_EXTRUDER' }, click: function() { $parent.setActiveTool(1); }">
                <i class="fas fa-arrow-left"></i> Left (T1)
            </label>
            <span class="bb-status-meta">Current: <strong data-bind="text: activeTool"></strong></span>
        </div>
    </div>
    <!-- /ko -->

    <!-- Temperature Cards -->
    <div class="bb-card-row">
        <div class="bb-card bb-temp-card">
            <h4>Bed</h4>
            <div class="bb-temp-value" data-bind="text: bedTemp().toFixed(1) + '°C'"></div>
            <div class="bb-temp-target">Target: <span data-bind="text: bedTempTarget() + '°C'"></span></div>
            <div class="input-append">
                <input type="number" min="0" max="120" placeholder="°C" style="width:60px" data-bind="value: bedTempInput">
                <button class="btn btn-small" data-bind="click: $parent.setBedTemp">Set</button>
            </div>
        </div>
        <div class="bb-card bb-temp-card">
            <h4>Nozzle</h4>
            <div class="bb-temp-value" data-bind="text: nozzleTemp().toFixed(1) + '°C'"></div>
            <div class="bb-temp-target">Target: <span data-bind="text: nozzleTempTarget() + '°C'"></span></div>
            <div class="input-append">
                <input type="number" min="0" max="300" placeholder="°C" style="width:60px" data-bind="value: nozzleTempInput">
                <button class="btn btn-small" data-bind="click: $parent.setNozzleTemp">Set</button>
            </div>
        </div>
        <!-- ko if: hasChamberTemp -->
        <div class="bb-card bb-temp-card">
            <h4>Chamber</h4>
            <div class="bb-temp-value" data-bind="text: chamberTemp().toFixed(1) + '°C'"></div>
            <div class="bb-temp-target">Target: <span data-bind="text: chamberTempTarget() + '°C'"></span></div>
            <div class="input-append">
                <input type="number" min="0" max="70" placeholder="°C" style="width:60px" data-bind="value: chamberTempInput">
                <button class="btn btn-small" data-bind="click: $parent.setChamberTemp">Set</button>
            </div>
        </div>
        <!-- /ko -->
    </div>

    <!-- Nozzle Configuration Card -->
    <div class="bb-card">
        <h4>Nozzle Configuration</h4>
        <div class="bb-controls-row">
            <div>
                <label>Diameter:</label>
                <select id="bb-nozzle-diameter" data-bind="value: nozzleDiameter">
                    <option value="POINT_TWO_MM">0.2mm</option>
                    <option value="POINT_FOUR_MM">0.4mm</option>
                    <option value="POINT_SIX_MM">0.6mm</option>
                    <option value="POINT_EIGHT_MM">0.8mm</option>
                </select>
            </div>
            <div>
                <label>Type:</label>
                <select id="bb-nozzle-type" data-bind="value: nozzleType">
                    <option value="STAINLESS_STEEL">Stainless Steel</option>
                    <option value="HARDENED_STEEL">Hardened Steel</option>
                    <option value="HS01">HS01</option>
                    <option value="HH01">HH01</option>
                </select>
            </div>
            <button class="btn btn-small" data-bind="click: function() { $parent.setNozzleDetails(nozzleDiameter(), nozzleType()); }">
                <i class="fas fa-save"></i> Apply
            </button>
        </div>
    </div>

    <!-- Fan Controls -->
    <div class="bb-card">
        <h4>Fans</h4>
        <div class="bb-fan-row">
            <label>Part Cooling: <strong data-bind="text: partFanSpeed() + '%'"></strong></label>
            <input type="range" min="0" max="100" data-bind="value: partFanSpeed, event: { change: $parent.setPartFan }">
        </div>
        <div class="bb-fan-row">
            <label>Aux Fan: <strong data-bind="text: auxFanSpeed() + '%'"></strong></label>
            <input type="range" min="0" max="100" data-bind="value: auxFanSpeed, event: { change: $parent.setAuxFan }">
        </div>
        <div class="bb-fan-row">
            <label>Exhaust Fan: <strong data-bind="text: exhaustFanSpeed() + '%'"></strong></label>
            <input type="range" min="0" max="100" data-bind="value: exhaustFanSpeed, event: { change: $parent.setExhaustFan }">
        </div>
        <div class="bb-fan-row" data-bind="visible: heatbreakFanSpeed() > 0">
            <label>Heatbreak Fan: <strong data-bind="text: heatbreakFanSpeed() + '%'"></strong></label>
            <div class="bb-fan-readonly-bar" data-bind="style: { width: heatbreakFanSpeed() + '%' }"></div>
        </div>
    </div>

    <!-- Air Filtration Card -->
    <!-- ko if: hasAirFiltration -->
    <div class="bb-card">
        <h4><i class="fas fa-wind"></i> Air Filtration</h4>
        <div class="bb-air-filtration-grid">
            <div class="bb-af-item">
                <span class="bb-af-label">AC Mode</span>
                <span data-bind="text: airConditioningMode"></span>
            </div>
            <div class="bb-af-item">
                <span class="bb-af-label">Intake</span>
                <span data-bind="text: zoneIntakeOpen() ? 'Open' : 'Closed'"></span>
            </div>
            <div class="bb-af-item">
                <span class="bb-af-label">Top Vent</span>
                <span data-bind="text: zoneTopVentOpen() ? 'Open' : 'Closed'"></span>
            </div>
            <div class="bb-af-item">
                <span class="bb-af-label">Door</span>
                <span data-bind="text: isChamberDoorOpen() ? 'Open' : 'Closed', css: { 'text-warning': isChamberDoorOpen() }"></span>
            </div>
            <div class="bb-af-item">
                <span class="bb-af-label">Zone Part Fan</span>
                <span data-bind="text: zonePartFanPercent() + '%'"></span>
            </div>
            <div class="bb-af-item">
                <span class="bb-af-label">Zone Aux</span>
                <span data-bind="text: zoneAuxPercent() + '%'"></span>
            </div>
            <div class="bb-af-item">
                <span class="bb-af-label">Zone Exhaust</span>
                <span data-bind="text: zoneExhaustPercent() + '%'"></span>
            </div>
        </div>
    </div>
    <!-- /ko -->

    <!-- Print Controls -->
    <div class="bb-card">
        <h4>Controls</h4>
        <div class="bb-controls-row">
            <button class="btn" data-bind="click: $parent.pausePrinting, visible: isPrinting()"><i class="fas fa-pause"></i> Pause</button>
            <button class="btn" data-bind="click: $parent.resumePrinting, visible: isPaused()"><i class="fas fa-play"></i> Resume</button>
            <button class="btn btn-danger" data-bind="click: $parent.stopPrinting, visible: isPrinting() || isPaused()"><i class="fas fa-stop"></i> Stop</button>

            <div class="bb-speed-control">
                <label>Speed:</label>
                <select data-bind="value: speedLevel, event: { change: function(d,e) { $parent.setSpeedLevel(parseInt(e.target.value)); } }">
                    <option value="1">Silent</option>
                    <option value="2">Standard</option>
                    <option value="3">Sport</option>
                    <option value="4">Ludicrous</option>
                </select>
            </div>

            <button class="btn btn-small" data-bind="click: $parent.toggleLight, css: { active: lightState() }">
                <i class="fas fa-lightbulb"></i> LED <span data-bind="text: lightState() ? 'ON' : 'OFF'"></span>
            </button>
        </div>
    </div>

    <!-- AMS Section -->
    <!-- ko if: hasAms -->
    <div class="bb-card">
        <h4>AMS <small data-bind="text: '(' + amsConnectedCount() + ' connected)'"></small>
            <div class="btn-group btn-group-mini" style="margin-left:8px">
                <button class="btn btn-mini" data-bind="click: function() { $parent.sendAmsControlCommand('PAUSE'); }" title="Pause AMS"><i class="fas fa-pause"></i></button>
                <button class="btn btn-mini" data-bind="click: function() { $parent.sendAmsControlCommand('RESUME'); }" title="Resume AMS"><i class="fas fa-play"></i></button>
                <button class="btn btn-mini" data-bind="click: function() { $parent.sendAmsControlCommand('RESET'); }" title="Reset AMS"><i class="fas fa-redo"></i></button>
            </div>
        </h4>

        <!-- AMS User Settings -->
        <div class="bb-options-grid" style="margin-bottom:10px">
            <label>
                <input type="checkbox" data-bind="checked: startupReadOption, click: function() { $parent.setAmsUserSetting('STARTUP_READ_OPTION', !startupReadOption()); return true; }">
                Read RFID on startup
            </label>
            <label>
                <input type="checkbox" data-bind="checked: trayReadOption, click: function() { $parent.setAmsUserSetting('TRAY_READ_OPTION', !trayReadOption()); return true; }">
                Read RFID on tray change
            </label>
            <label>
                <input type="checkbox" data-bind="checked: calibrateRemainFlag, click: function() { $parent.setAmsUserSetting('CALIBRATE_REMAIN_FLAG', !calibrateRemainFlag()); return true; }">
                Calculate remaining filament
            </label>
        </div>

        <div data-bind="foreach: amsUnits" class="bb-ams-units">
            <div class="bb-ams-unit">
                <div class="bb-ams-header">
                    <strong data-bind="text: 'AMS ' + ($index() + 1)"></strong>
                    <span data-bind="text: model"></span>
                    <span data-bind="visible: temp_actual > 0, text: temp_actual.toFixed(1) + '°C'"></span>
                    <span class="bb-ams-humidity" data-bind="visible: humidity_index > 0, text: 'Humidity: ' + humidity_index"></span>
                </div>
                <div class="bb-ams-trays">
                    <!-- ko foreach: tray_exists -->
                    <!-- ko template: { name: 'bb-tray-slot', data: { exists: $data, slotIndex: $index(), amsId: $parent.ams_id, spool: $parents[2].getSpoolForTray($parent.ams_id, $index()) } } --><!-- /ko -->
                    <!-- /ko -->
                </div>
                <div class="bb-ams-dryer">
                    <span data-bind="text: heater_state"></span>
                    <span data-bind="visible: dry_time > 0">
                        <span data-bind="text: dry_time + ' min remaining'"></span>
                        <span data-bind="visible: temp_target > 0, text: '@ ' + temp_target + '°C'"></span>
                    </span>
                    <button class="btn btn-mini" data-bind="click: function() { $parents[1].startAmsDryer(ams_id); }">Start Dryer</button>
                    <button class="btn btn-mini" data-bind="click: function() { $parents[1].stopAmsDryer(ams_id); }">Stop Dryer</button>
                </div>
            </div>
        </div>

        <!-- External Spool -->
        <div class="bb-ams-external" data-bind="with: $parent.getExternalSpool()">
            <div class="bb-ams-tray bb-tray-present bb-tray-external">
                <div class="bb-tray-color-bar" data-bind="style: { backgroundColor: $data.tray_color || '#808080' }"></div>
                <div class="bb-tray-content">
                    <span class="bb-tray-number">Ext</span>
                    <span class="bb-tray-type" data-bind="text: $data.tray_type || 'Empty'"></span>
                    <span class="bb-tray-name" data-bind="visible: $data.tray_id_name, text: $data.tray_id_name"></span>
                    <span class="bb-tray-remain" data-bind="visible: $data.remain_percent >= 0, text: $data.remain_percent + '%'"></span>
                </div>
                <div class="bb-tray-actions">
                    <button class="btn btn-mini" data-bind="click: function() { $parents[1].openSpoolEditor($data); }" title="Edit"><i class="fas fa-edit"></i></button>
                </div>
            </div>
        </div>

        <div class="bb-ams-actions">
            <button class="btn btn-small" data-bind="click: function() { $parent.unloadFilament(0); }"><i class="fas fa-eject"></i> Unload Filament</button>
        </div>
    </div>
    <!-- /ko -->

    <!-- Spool Detail Editor Modal -->
    <!-- ko if: spoolEditorVisible -->
    <div class="bb-modal-overlay" data-bind="click: $parent.closeSpoolEditor">
        <div class="bb-modal bb-spool-editor" data-bind="click: function(){}, clickBubble: false">
            <h4>Edit Spool
                <span class="bb-spool-preview" data-bind="style: { backgroundColor: '#' + (editingSpool().tray_color() || '808080') }"></span>
                <span data-bind="text: editingSpool().tray_type() || 'Unknown'"></span>
                <button class="close" data-bind="click: $parent.closeSpoolEditor">&times;</button>
            </h4>
            <!-- ko with: editingSpool -->

            <!-- Filament Type Dropdown -->
            <div class="control-group">
                <label class="control-label">Filament Type</label>
                <div class="controls">
                    <select class="bb-select" data-bind="value: tray_type, options: $root.filamentTypes, optionsCaption: '-- Select --'" style="width:180px"></select>
                    <small class="bb-preset-hint" data-bind="visible: tray_type()">Temps auto-filled from presets</small>
                </div>
            </div>

            <!-- Spool Name -->
            <div class="control-group">
                <label class="control-label">Name <small>(optional)</small></label>
                <div class="controls"><input type="text" data-bind="value: tray_id_name" placeholder="e.g. Bambu PLA Matte"></div>
            </div>

            <!-- Color Palette -->
            <div class="control-group">
                <label class="control-label">Color</label>
                <div class="controls">
                    <div class="bb-color-palette" data-bind="foreach: $root.filamentColors">
                        <span class="bb-color-swatch"
                              data-bind="style: { backgroundColor: '#' + hex },
                                         attr: { title: name },
                                         css: { 'bb-swatch-selected': $parent.tray_color() === hex },
                                         click: function() { $parent.tray_color(hex); }"></span>
                    </div>
                    <div class="bb-color-custom" style="margin-top:6px">
                        <label style="font-size:11px">Custom hex:</label>
                        <input type="text" data-bind="value: tray_color" placeholder="FF0000" style="width:80px;font-family:monospace">
                        <span class="bb-spool-color-preview" data-bind="style: { backgroundColor: '#' + (tray_color() || '808080') }"></span>
                    </div>
                </div>
            </div>

            <!-- Temperature Range -->
            <div class="control-group">
                <label class="control-label">Nozzle Temp</label>
                <div class="controls bb-temp-range">
                    <input type="number" min="0" max="350" data-bind="value: nozzle_temp_min" style="width:65px"> &ndash;
                    <input type="number" min="0" max="350" data-bind="value: nozzle_temp_max" style="width:65px"> °C
                </div>
            </div>

            <!-- Advanced (collapsed by default) -->
            <details class="bb-spool-advanced">
                <summary>Advanced</summary>
                <div class="control-group">
                    <label class="control-label">Info Index</label>
                    <div class="controls"><input type="text" data-bind="value: tray_info_idx" style="width:120px;font-family:monospace"></div>
                </div>
            </details>

            <!-- /ko -->
            <div class="bb-modal-footer">
                <button class="btn btn-primary" data-bind="click: $parent.saveSpoolDetails">Save</button>
                <button class="btn" data-bind="click: $parent.closeSpoolEditor">Cancel</button>
            </div>
        </div>
    </div>
    <!-- /ko -->

    <!-- HMS Errors -->
    <div data-bind="visible: hmsErrors().length > 0" class="bb-card bb-hms-errors">
        <h4><i class="fas fa-exclamation-triangle"></i> HMS Errors</h4>
        <div data-bind="foreach: hmsErrors">
            <div class="bb-hms-error">
                <span class="bb-hms-code" data-bind="text: $data.code || 'Unknown'"></span>
                <span data-bind="text: $data.msg || $data.description || JSON.stringify($data)"></span>
            </div>
        </div>
    </div>

    <!-- File Browser -->
    <div class="bb-card">
        <h4>Files
            <button class="btn btn-small" data-bind="click: $parent.loadFiles, disable: filesLoading()">
                <span data-bind="visible: !filesLoading()"><i class="fas fa-folder-open"></i> Load</span>
                <span data-bind="visible: filesLoading()"><i class="fas fa-spinner fa-spin"></i></span>
            </button>
            <button class="btn btn-small" data-bind="click: $parent.makeDirectory"><i class="fas fa-folder-plus"></i> New Folder</button>
            <label class="btn btn-small btn-file">
                <i class="fas fa-upload"></i> Upload
                <input type="file" style="display:none" accept=".3mf,.gcode" data-bind="event: { change: $parent.uploadFile }">
            </label>
        </h4>
        <div data-bind="visible: sdCardContents()">
            <div data-bind="foreach: fileList" class="bb-file-list">
                <div class="bb-file-item">
                    <span class="bb-file-name" data-bind="text: $data"></span>
                    <!-- ko if: $data.endsWith('.3mf') -->
                    <button class="btn btn-mini btn-primary" data-bind="click: function() { $parents[1].startPrint($data); }">Print</button>
                    <!-- /ko -->
                    <button class="btn btn-mini" data-bind="click: function() { $parents[1].renameFile($data); }" title="Rename"><i class="fas fa-pen"></i></button>
                    <button class="btn btn-mini btn-danger" data-bind="click: function() { $parents[1].deleteFile($data); }"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        </div>
        <div data-bind="visible: !sdCardContents()" class="bb-file-empty">
            Click "Load" to browse printer files
        </div>
    </div>

    <!-- G-code Console -->
    <div class="bb-card">
        <h4>G-code Console</h4>
        <div class="bb-gcode-input">
            <input type="text" placeholder="Enter G-code command..." data-bind="value: gcodeInput, valueUpdate: 'afterkeydown', event: { keypress: function(d, e) { if (e.keyCode === 13) { $parent.sendGcode(); return false; } return true; } }">
            <button class="btn" data-bind="click: $parent.sendGcode">Send</button>
        </div>
        <div class="bb-gcode-history" data-bind="foreach: gcodeHistory">
            <div class="bb-gcode-entry">
                <span class="bb-gcode-time" data-bind="text: time"></span>
                <code data-bind="text: command"></code>
            </div>
        </div>
    </div>

    <!-- Raw JSON Console -->
    <div class="bb-card">
        <h4>Raw MQTT Console</h4>
        <div class="bb-gcode-input">
            <textarea rows="3" style="flex:1;font-family:monospace;font-size:12px;margin:0" placeholder='{"pushing":{"command":"M104 S200"}}' data-bind="value: rawJsonInput"></textarea>
            <button class="btn" data-bind="click: $parent.sendAnything">Send</button>
        </div>
        <p class="help-block" style="margin:4px 0 0;font-size:11px">Send raw JSON payload directly to printer MQTT</p>
    </div>

    <!-- Print Options -->
    <div class="bb-card">
        <h4>Print Options</h4>
        <div class="bb-options-grid">
            <label>
                <input type="checkbox" data-bind="checked: autoRecovery, event: { change: function() { $parent.setPrintOption('AUTO_RECOVERY', autoRecovery()); } }">
                Auto Recovery
            </label>
            <label>
                <input type="checkbox" data-bind="checked: filamentTangleDetect, event: { change: function() { $parent.setPrintOption('FILAMENT_TANGLE_DETECT', filamentTangleDetect()); } }">
                Filament Tangle Detect
            </label>
            <label>
                <input type="checkbox" data-bind="checked: soundEnable, event: { change: function() { $parent.setPrintOption('SOUND_ENABLE', soundEnable()); } }">
                Sound
            </label>
            <label>
                <input type="checkbox" data-bind="checked: autoSwitchFilament, event: { change: function() { $parent.setPrintOption('AUTO_SWITCH_FILAMENT', autoSwitchFilament()); } }">
                Auto Switch Filament
            </label>
            <label>
                <input type="checkbox" data-bind="checked: buildplateMarkerDetector, event: { change: function() { $parent.setBuildplateMarkerDetector(buildplateMarkerDetector()); } }">
                Buildplate Marker Detector
            </label>
        </div>
    </div>

    <!-- /ko -->

    <!-- No printer selected state -->
    <!-- ko ifnot: selectedPrinter -->
    <div class="bb-empty-state">
        <i class="fas fa-cubes bb-empty-icon"></i>
        <h3>No Printers Configured</h3>
        <p>Add your Bambu Lab printers in Settings &rarr; BambuBoard</p>
    </div>
    <!-- /ko -->
</div>

<!-- AMS Tray Slot Template -->
<script type="text/html" id="bb-tray-slot">
    <div class="bb-ams-tray" data-bind="css: { 'bb-tray-present': exists, 'bb-tray-active': spool && $parents[2] && $parents[2].activeTrayId && ($parents[2].activeTrayId() === (amsId * 4 + slotIndex)) }">
        <!-- Color header with slot number -->
        <!-- ko if: spool -->
        <div class="bb-tray-color-bar" data-bind="style: { backgroundColor: spool.tray_color || '#808080' }">
            <span class="bb-tray-number" data-bind="text: (slotIndex + 1)"></span>
        </div>
        <!-- /ko -->
        <!-- ko ifnot: spool -->
        <div class="bb-tray-color-bar bb-tray-color-empty">
            <span class="bb-tray-number" data-bind="text: (slotIndex + 1)"></span>
        </div>
        <!-- /ko -->
        <div class="bb-tray-content">
            <!-- ko if: spool -->
            <span class="bb-tray-type" data-bind="text: spool.tray_type || '?'"></span>
            <span class="bb-tray-name" data-bind="visible: spool.tray_id_name, text: spool.tray_id_name"></span>
            <span class="bb-tray-remain" data-bind="visible: spool.remain_percent >= 0, text: spool.remain_percent + '%'"></span>
            <!-- /ko -->
            <!-- ko ifnot: spool -->
            <!-- ko if: exists -->
            <span class="bb-tray-type bb-tray-empty">Empty</span>
            <!-- /ko -->
            <!-- ko ifnot: exists -->
            <span class="bb-tray-type bb-tray-none">—</span>
            <!-- /ko -->
            <!-- /ko -->
        </div>
        <div class="bb-tray-actions">
            <!-- ko if: exists -->
            <button class="btn btn-mini bb-tray-load-btn" data-bind="click: function() { $parents[3].loadFilament(slotIndex, amsId); }" title="Load filament">Load</button>
            <!-- /ko -->
            <!-- ko if: spool -->
            <button class="btn btn-mini" data-bind="click: function() { $parents[3].openSpoolEditor(spool); }" title="Edit"><i class="fas fa-edit"></i></button>
            <button class="btn btn-mini" data-bind="click: function() { $parents[3].refreshSpoolRfid(spool.slot_id, spool.ams_id); }" title="Refresh RFID"><i class="fas fa-tag"></i></button>
            <!-- /ko -->
        </div>
    </div>
</script>
